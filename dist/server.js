!function(e){var r={};function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)t.d(n,a,function(r){return e[r]}.bind(null,a));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="/",t(t.s=19)}([function(e,r){e.exports=require("mongoose")},function(e,r){e.exports=require("validator")},function(e,r){e.exports={mongoURI:"mongodb+srv://admin:6JsteBFmfKQUcqq0@cluster0-gaygc.mongodb.net/farmestar?retryWrites=true&w=majority",userAuthKey:"MTZlNWI0ZGQtODVmNC00NDliLTk3ODYtOTFkODE0NmUxYmQz",appAuthKey:"NDYyMDU0YmEtOGM5OS00YTQ2LTgxY2UtZGRjNTI5ZDI4OTgw",appId:"61035d16-4f24-4696-8645-cf5c54e20787",sendgridKey:"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",secretOrKey:"secret"}},function(e,r){e.exports=require("is-empty")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("bcryptjs")},function(e,r){e.exports=require("jsonwebtoken")},function(e,r){e.exports=require("crypto")},function(e,r){e.exports=require("nodemailer")},function(e,r){e.exports=require("nodemailer-sendgrid-transport")},function(e,r){e.exports=require("onesignal-node")},function(e,r){e.exports=require("passport-jwt")},function(e,r){e.exports=require("cookie-parser")},function(e,r){e.exports=require("body-parser")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("passport")},function(e,r){e.exports=require("stripe")},function(e,r){e.exports=require("babel-polyfill")},function(e,r,t){"use strict";t.r(r);var n=t(0),a=t.n(n),o=t(2),s=t.n(o),i=t(11).Strategy,u=t(11).ExtractJwt,d=a.a.model("users"),c={};c.jwtFromRequest=u.fromAuthHeaderAsBearerToken(),c.secretOrKey=s.a.secretOrKey,r.default=function(e){e.use(new i(c,(function(e,r){d.findById(e.id).then((function(e){return r(null,e||!1)})).catch((function(e){return console.log(e)}))})))}},function(e,r,t){"use strict";t.r(r);t(14);var n=t(4),a=t.n(n),o=t(0),s=t.n(o),i=t(12),u=t.n(i),d=t(10),c=t.n(d),f=t(13),p=t.n(f),m=t(5),l=t.n(m),y=t(6),h=t.n(y),w=t(7),g=t.n(w),b=t(8),v=t.n(b),q=t(9),j=t.n(q),S=t(2),x=t.n(S),O=t(1),E=t.n(O),T=t(3),N=t.n(T);var P=new s.a.Schema({name:{type:String,required:!0},lastName:{type:String,required:!1},email:{type:String,required:!0},password:{type:String,required:!0},isFarmer:{type:String,required:!0,default:!1},date:{type:Date,default:Date.now}}),k=s.a.model("users",P),D=new s.a.Schema({_userId:{type:s.a.Schema.Types.ObjectId,required:!0,ref:"user"},token:{type:String,required:!0},createdAt:{type:Date,required:!0,default:Date.now,expires:43200}}),I=s.a.model("token",D),F=new s.a.Schema({farmer:{type:s.a.Schema.Types.ObjectId,ref:"users"},farmName:{type:String,required:!0},address:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},farmerType:{type:String,required:!0},date:{type:Date,default:Date.now}}),_=s.a.model("farms",F),K=new s.a.Schema({farmer:{type:s.a.Schema.Types.ObjectId,ref:"users"},farm:{type:s.a.Schema.Types.ObjectId,ref:"farms"},displayName:{type:String,required:!0},description:{type:String,required:!0},image:{type:String},date:{type:Date,default:Date.now}}),R=s.a.model("profiles",K),U=new s.a.Schema({farm:{type:s.a.Schema.Types.ObjectId,ref:"farms"},title:{type:String,required:!0},description:{type:String,required:!1},price:{type:Number,required:!0},sku:{type:String,required:!0},date:{type:Date,default:Date.now}}),A=s.a.model("produce",U),Y=t(16)("sk_test_GFG8Z3zu7QO66KUwd4yQYX9B00TvN3UNJb");t(17);var M=v.a.createTransport(j()({auth:{api_key:x.a.sendgridKey}})),Q=a.a.Router();Q.post("/register",(function(e,r){var t=function(e){var r={};return e.name=N()(e.name)?"":e.name,e.email=N()(e.email)?"":e.email,e.password=N()(e.password)?"":e.password,e.password2=N()(e.password2)?"":e.password2,E.a.isEmpty(e.name)&&(r.name="Name field is required"),E.a.isEmpty(e.email)?r.email="Email field is required":E.a.isEmail(e.email)||(r.email="Email is invalid, please use a valid email"),E.a.isEmpty(e.password)&&(r.password="Password field is required"),E.a.isEmpty(e.password2)&&(r.password2="Confirm password field is required"),E.a.isLength(e.password,{min:6,max:30})||(r.password="Password must be at least 6 characters"),E.a.equals(e.password,e.password2)||(r.password2="Passwords must match"),{errors:r,isValid:N()(r)}}(e.body),n=t.errors;if(!t.isValid)return r.status(400).json(n);k.findOne({email:e.body.email}).then((function(t){if(t)return r.status(400).json({email:"Email already exists"});var n=new k({name:e.body.name,lastName:e.body.lastName,email:e.body.email,isFarmer:e.body.isFarmer,password:e.body.password});l.a.genSalt(10,(function(e,t){l.a.hash(n.password,t,(function(e,t){if(e)throw e;n.password=t,n.save().then((function(e){r.json(e)})).catch((function(e){return console.log(e)}))}))}))}))})),Q.post("/login",(function(e,r){var t=function(e){var r={};return e.email=N()(e.email)?"":e.email,e.password=N()(e.password)?"":e.password,E.a.isEmpty(e.email)?r.email="Email field is required":E.a.isEmail(e.email)||(r.email="Email is invalid"),E.a.isEmpty(e.password)&&(r.password="Password field is required"),{errors:r,isValid:N()(r)}}(e.body),n=t.errors;if(!t.isValid)return r.status(400).json(n);var a=e.body.email,o=e.body.password,s={user:{id:"",name:"",email:""},token:"",isFarmer:"",success:!1,farms:[],produce:[],reviews:[],profiles:[]};k.findOne({email:a}).then((function(e){if(!e)return r.status(404).json({emailnotfound:"Email not found"});s.user.id=e.id,s.user.name=e.name,s.user.email=e.email,s.user.isFarmer=e.isFarmer,l.a.compare(o,e.password).then((function(e){if(!e)return r.status(400).json({passwordincorrect:"Password incorrect"});h.a.sign(s.user,x.a.secretOrKey,{expiresIn:31556926},(function(e,t){_.find({},(function(e,n){n.forEach((function(e){s.farms.push(e)})),R.find({},(function(e,n){n.forEach((function(e){s.profiles.push(e)})),A.find({},(function(e,n){n.forEach((function(e){s.produce.push(e)})),s.success=!0,s.token="Bearer "+t,r.json(s)}))}))}))}))}))}))})),Q.post("/forgotPassword",(function(e,r){k.findOne({email:e.body.email}).then((function(t){if(!t)return r.status(400).json({email:"Email does not exist"});var n=new I({_userId:t._id,token:g.a.randomBytes(16).toString("hex")});n.save();var a={to:t.email,from:"admin@farmestar.com",subject:"FarmEstar, Reset Password",html:"Hello,\n\nWe have been notified that you requested to reset your password. Please do so following this url: \nhttp://"+e.headers.host+"/updatePassword/"+n.token+".\n"};M.sendMail(a,(function(e,r){e?console.log(e.message):console.log("A verification email has been sent to "+t.email+".")})),r.json(t)}))})),Q.post("/updatePassword",(function(e,r){I.findOne({token:e.body.token},(function(t,n){if(!n)return r.status(400).send({type:"not-verified",msg:"We were unable to find a valid token. Your token my have expired."});k.findOne({email:e.body.email},(function(t,n){if(!n)return r.status(400).send({type:"no-email",msg:"This user could not be found. Please try again."});var a=new k({name:n.name,email:n.email,password:e.body.password,isFarmer:n.isFarmer});l.a.genSalt(10,(function(e,t){l.a.hash(a.password,t,(function(e,t){if(e)throw e;a.password=t,a.save().then((function(e){r.json(e.email+" has updated their password succesfully.")})).catch((function(e){return r.json(e)}))}))}))}))}))})),Q.post("/charge",(function(e,r){var t,n;return regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,regeneratorRuntime.awrap(Y.charges.create({amount:e.body.total,currency:"usd",description:"Farm Estar Purchase",source:e.body.tokenId}));case 3:t=a.sent,n=t.status,r.json({status:n}),a.next=12;break;case 8:a.prev=8,a.t0=a.catch(0),console.log(a.t0),r.status(500).end();case 12:case"end":return a.stop()}}),null,null,[[0,8]])})),Q.get("/dashboard",(function(e,r){var t={farms:[],reviews:[]};_.find({},(function(e,n){n.forEach((function(e){t.farms.push(e)})),r.send(t)}))}));var B=new s.a.Schema({name:{type:String,required:!0},version:{type:String,required:!0},date:{type:Date,default:Date.now}}),G=s.a.model("app",B),V=a.a.Router();V.post("/app",(function(e,r){G.findOne({version:e.body.version}).then((function(t){if(t)return r.status(400).json({version:"Version already exists, please update and try again."});new G({name:e.body.name,version:e.body.version}).save().then((function(e){return r.json(e)})).catch((function(e){return console.log(e)}))}))})),V.get("/version",(function(e,r){G.find().sort("-date").limit(1).find((function(e,t){return r.json(t)}))}));var Z=a.a.Router();Z.post("/add",(function(e,r){new _({farmer:e.body.farmer,farmName:e.body.farmName,address:e.body.address,city:e.body.city,zipcode:e.body.zipcode,state:e.body.state,farmerType:e.body.farmerType}).save().then((function(e){r.json(e)})).catch((function(e){return r.json(e)}))})),Z.post("/addFarmProfile",(function(e,r){new R({farmer:e.body.farmer,farm:e.body.farm,displayName:e.body.displayName,description:e.body.description,image:e.body.image}).save().then((function(e){r.json(e)})).catch((function(e){return r.json(e)}))})),Z.get("/farms",(function(e,r){var t={farms:[]};_.find({},(function(e,n){n.forEach((function(e){t.farms.push(e)})),r.json(t)}))})),Z.post("/farmProfile",(function(e,r){var t=e.body.farm_id;R.findOne({farm:t},(function(e,t){r.json(t)})).catch((function(e){return r.json(e)}))})),Z.post("/addProduce",(function(e,r){new A({farm:e.body.farm,title:e.body.title,description:e.body.description,price:e.body.price,sku:e.body.sku}).save().then((function(e){r.json(e)})).catch((function(e){return r.json(e)}))}));var z=t(15),L=t(2).userAuthKey,C=t(2).appAuthKey,J=t(2).appId;s.a.connect(S.mongoURI,{useNewUrlParser:!0,autoIndex:!1,useUnifiedTopology:!0}).then((function(){return console.log("MongoDB Successfully Connected")})).catch((function(e){return console.log(e)}));var W=a()();W.use(a.a.static("./dist/")),W.use(u()()),t(18),W.use(z.initialize()),W.use(p()());new c.a.Client({userAuthKey:L,app:{appAuthKey:C,appId:J}});W.use("/api/users",Q),W.use("/api/app",V),W.use("/api/farm",Z),W.all("*",(function(e,r){r.sendFile("/index.html",{root:"./dist/"})}));var H=process.env.PORT||8080;W.listen(H,(function(){console.log("***Server running on Port:".concat(H,"***"))}))}]);