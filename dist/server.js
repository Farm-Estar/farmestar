!function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="/",t(t.s=21)}([function(e,r){e.exports=require("mongoose")},function(e,r){e.exports={mongoURI:"mongodb+srv://admin:6JsteBFmfKQUcqq0@cluster0-gaygc.mongodb.net/farmestar?retryWrites=true&w=majority",userAuthKey:"MTZlNWI0ZGQtODVmNC00NDliLTk3ODYtOTFkODE0NmUxYmQz",appAuthKey:"NDYyMDU0YmEtOGM5OS00YTQ2LTgxY2UtZGRjNTI5ZDI4OTgw",appId:"61035d16-4f24-4696-8645-cf5c54e20787",sendgridKey:"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",secretOrKey:"secret",firebaseAPIKey:"AIzaSyA2IjtW7jbl1_2m1CJ68lYGGnTHQAFu8DI",firebaseAuthDomain:"farm-estar.firebaseapp.com",firebaseDBUrl:"https://farm-estar.firebaseio.com",firebaseProjectID:"farm-estar",firebaseStorageBucket:"farm-estar.appspot.com",firebaseAppID:"1:980885994768:web:ab15ff912f8dcb96b9f995",firebaseMeasurementId:"G-GPX1EL4KC8",firebaseMessagingSenderId:"980885994768"}},function(e,r){e.exports=require("validator")},function(e,r){e.exports=require("is-empty")},function(e,r){e.exports=require("express")},function(e,r){e.exports=require("bcryptjs")},function(e,r){e.exports=require("jsonwebtoken")},function(e,r){e.exports=require("crypto")},function(e,r){e.exports=require("nodemailer")},function(e,r){e.exports=require("nodemailer-sendgrid-transport")},function(e,r){e.exports=require("onesignal-node")},function(e,r){e.exports=require("passport-jwt")},function(e,r){e.exports=require("cookie-parser")},function(e,r){e.exports=require("body-parser")},function(e,r){e.exports=require("mongoose-unique-validator")},function(e,r){e.exports=require("node-geocoder")},function(e,r){e.exports=require("path")},function(e,r){e.exports=require("passport")},function(e,r){e.exports=require("stripe")},function(e,r){e.exports=require("babel-polyfill")},function(e,r,t){"use strict";t.r(r);var n=t(0),o=t.n(n),a=t(1),i=t.n(a),s=t(11).Strategy,u=t(11).ExtractJwt,d=o.a.model("users"),c={};c.jwtFromRequest=u.fromAuthHeaderAsBearerToken(),c.secretOrKey=i.a.secretOrKey,r.default=function(e){e.use(new s(c,(function(e,r){d.findById(e.id).then((function(e){return r(null,e||!1)})).catch((function(e){return console.log(e)}))})))}},function(e,r,t){"use strict";t.r(r);t(16);var n=t(4),o=t.n(n),a=t(0),i=t.n(a),s=t(12),u=t.n(s),d=t(10),c=t.n(d),f=t(13),p=t.n(f),l=t(5),m=t.n(l),y=t(6),g=t.n(y),b=t(7),h=t.n(b),w=t(8),v=t.n(w),S=t(9),q=t.n(S),j=t(1),x=t.n(j),O=t(2),P=t.n(O),I=t(3),E=t.n(I);var D=t(14),k=t.n(D),N=new i.a.Schema({name:{type:String,required:!0},lastName:{type:String,required:!1},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},isFarmer:{type:String,required:!0,default:!1},isLegalVerified:{type:String,default:!1},date:{type:Date,default:Date.now}});N.plugin(k.a);var U=i.a.model("users",N),A=new i.a.Schema({_userId:{type:i.a.Schema.Types.ObjectId,required:!0,ref:"user"},token:{type:String,required:!0},createdAt:{type:Date,required:!0,default:Date.now,expires:43200}}),T=i.a.model("token",A),F=new i.a.Schema({farmer:{type:i.a.Schema.Types.ObjectId,ref:"users"},farmName:{type:String,required:!0},address:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},farmerType:{type:String,required:!0},location:{type:{type:String,enum:["Point"],required:!0},coordinates:{type:[Number],required:!0}},date:{type:Date,default:Date.now}}),K=i.a.model("farms",F),_=new i.a.Schema({farmer:{type:i.a.Schema.Types.ObjectId,ref:"users"},farm:{type:i.a.Schema.Types.ObjectId,ref:"farms"},displayName:{type:String,required:!0},description:{type:String,required:!0},imageUrl:{type:String},hours:{monOpen:{type:String},monClose:{type:String},tuesOpen:{type:String},tuesClose:{type:String},wedOpen:{type:String},wedClose:{type:String},thursOpen:{type:String},thursClose:{type:String},friOpen:{type:String},friClose:{type:String},satOpen:{type:String},satClose:{type:String},sunOpen:{type:String},sunClose:{type:String}},date:{type:Date,default:Date.now}}),C=i.a.model("profiles",_),G=new i.a.Schema({farm:{type:i.a.Schema.Types.ObjectId,ref:"farms"},title:{type:String,required:!0},description:{type:String,required:!1},price:{type:Number,required:!0},sku:{type:String,required:!0},date:{type:Date,default:Date.now}}),R=i.a.model("produce",G);function B(e,r,t,n,o,a,i){try{var s=e[a](i),u=s.value}catch(e){return void t(e)}s.done?r(u):Promise.resolve(u).then(n,o)}var L=t(18)("sk_test_GFG8Z3zu7QO66KUwd4yQYX9B00TvN3UNJb");t(19);var M=v.a.createTransport(q()({auth:{api_key:x.a.sendgridKey}})),Y=o.a.Router();Y.post("/register",(function(e,r){var t=function(e){var r={};return e.name=E()(e.name)?"":e.name,e.email=E()(e.email)?"":e.email,e.password=E()(e.password)?"":e.password,e.password2=E()(e.password2)?"":e.password2,P.a.isEmpty(e.name)&&(r.name="Name field is required"),P.a.isEmpty(e.email)?r.email="Email field is required":P.a.isEmail(e.email)||(r.email="Email is invalid, please use a valid email"),P.a.isEmpty(e.password)&&(r.password="Password field is required"),P.a.isEmpty(e.password2)&&(r.password2="Confirm password field is required"),P.a.isLength(e.password,{min:6,max:30})||(r.password="Password must be at least 6 characters"),P.a.equals(e.password,e.password2)||(r.password2="Passwords must match"),{errors:r,isValid:E()(r)}}(e.body),n=t.errors;if(!t.isValid)return r.status(400).json(n);U.findOne({email:e.body.email}).then((function(t){if(t)return r.status(400).json({email:"Email already exists"});var n=new U({name:e.body.name,lastName:e.body.lastName,email:e.body.email,isFarmer:e.body.isFarmer,isLegalVerified:e.body.isLegalVerified,password:e.body.password});m.a.genSalt(10,(function(e,t){m.a.hash(n.password,t,(function(e,t){if(e)throw e;n.password=t,n.save().then((function(e){r.json(e)})).catch((function(e){return console.log(e)}))}))}))}))})),Y.post("/login",(function(e,r){var t=function(e){var r={};return e.email=E()(e.email)?"":e.email,e.password=E()(e.password)?"":e.password,P.a.isEmpty(e.email)?r.email="Email field is required":P.a.isEmail(e.email)||(r.email="Email is invalid"),P.a.isEmpty(e.password)&&(r.password="Password field is required"),{errors:r,isValid:E()(r)}}(e.body),n=t.errors;if(!t.isValid)return r.status(400).json(n);var o=e.body.email,a=e.body.password,i={user:{id:"",name:"",email:""},token:"",isFarmer:"",success:!1,farms:[],produce:[],reviews:[],profiles:[]};U.findOne({email:o}).then((function(e){if(!e)return r.status(404).json({emailnotfound:"Email not found"});i.user.id=e.id,i.user.name=e.name,i.user.email=e.email,i.user.isFarmer=e.isFarmer,m.a.compare(a,e.password).then((function(e){if(!e)return r.status(400).json({passwordincorrect:"Password incorrect"});g.a.sign(i.user,x.a.secretOrKey,{expiresIn:31556926},(function(e,t){K.find({},(function(e,n){n.forEach((function(e){i.farms.push(e)})),C.find({},(function(e,n){n.forEach((function(e){i.profiles.push(e)})),R.find({},(function(e,n){n.forEach((function(e){i.produce.push(e)})),i.success=!0,i.token="Bearer "+t,r.json(i)}))}))}))}))}))}))})),Y.post("/guestLogin",(function(e,r){var t={user:{id:"",name:"",email:""},token:"",isFarmer:"",success:!1,farms:[],produce:[],reviews:[],profiles:[]};U.findOne({email:"Guest@FarmEstar.com"}).then((function(e){if(!e)return r.status(404).json({emailnotfound:"Guest User Not Applicable, Please create a profile or try again later."});t.user.id=e.id,t.user.name=e.name,t.user.email=e.email,t.user.isFarmer=e.isFarmer,m.a.compare("GuestUser",e.password).then((function(e){if(!e)return r.status(400).json({passwordincorrect:"Password error for guest login"});g.a.sign(t.user,x.a.secretOrKey,{expiresIn:31556926},(function(e,n){K.find({},(function(e,o){o.forEach((function(e){t.farms.push(e)})),C.find({},(function(e,o){o.forEach((function(e){t.profiles.push(e)})),R.find({},(function(e,o){o.forEach((function(e){t.produce.push(e)})),t.success=!0,t.token="Bearer "+n,r.json(t)}))}))}))}))}))}))})),Y.post("/forgotPassword",(function(e,r){U.findOne({email:e.body.email}).then((function(t){if(!t)return r.status(400).json({email:"Email does not exist"});var n=new T({_userId:t._id,token:h.a.randomBytes(16).toString("hex")});n.save();var o={to:t.email,from:"admin@farmestar.com",subject:"FarmEstar, Reset Password",html:"Hello,\n\nWe have been notified that you requested to reset your password. Please do so following this url: \nhttp://"+e.headers.host+"/updatePassword/"+n.token+".\n"};M.sendMail(o,(function(e,r){e?console.log(e.message):console.log("A verification email has been sent to "+t.email+".")})),r.json(t)}))})),Y.post("/updatePassword",(function(e,r){T.findOne({token:e.body.token},(function(t,n){if(!n)return r.status(400).send({type:"not-verified",msg:"We were unable to find a valid token. Your token my have expired."});m.a.genSalt(10,(function(t,n){m.a.hash(e.body.password,n,(function(t,n){if(t)throw t;U.findOneAndUpdate({email:e.body.email},{$set:{password:n}},{new:!0},(function(e,t){e&&r.json(e),r.json("User has updated passwor, User: "+JSON.stringify(t))}))}))}))}))})),Y.post("/charge",function(){var e,r=(e=regeneratorRuntime.mark((function e(r,t){var n,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,L.charges.create({amount:r.body.total,currency:"usd",description:"Farm Estar Purchase",source:r.body.tokenId});case 3:n=e.sent,o=n.status,t.json({status:o}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.log(e.t0),t.status(500).end();case 12:case"end":return e.stop()}}),e,null,[[0,8]])})),function(){var r=this,t=arguments;return new Promise((function(n,o){var a=e.apply(r,t);function i(e){B(a,n,o,i,s,"next",e)}function s(e){B(a,n,o,i,s,"throw",e)}i(void 0)}))});return function(e,t){return r.apply(this,arguments)}}()),Y.get("/dashboard",(function(e,r){var t={farms:[],reviews:[]};K.find({},(function(e,n){n.forEach((function(e){t.farms.push(e)})),r.send(t)}))}));var z=new i.a.Schema({name:{type:String,required:!0},version:{type:String,required:!0},date:{type:Date,default:Date.now}}),Q=i.a.model("app",z),V=o.a.Router();V.post("/app",(function(e,r){Q.findOne({version:e.body.version}).then((function(t){if(t)return r.status(400).json({version:"Version already exists, please update and try again."});new Q({name:e.body.name,version:e.body.version}).save().then((function(e){return r.json(e)})).catch((function(e){return console.log(e)}))}))})),V.get("/version",(function(e,r){Q.find().sort("-date").limit(1).find((function(e,t){return r.json(t)}))}));var Z=t(15),J=t.n(Z),W=o.a.Router();W.post("/add",(function(e,r){J()({provider:"google",httpAdaptor:"https",apiKey:"AIzaSyDzPWbAxZiZwpnen7giLpjhiKPHaFa48D4",formatter:null}).geocode({address:e.body.address,country:"United States",zipcode:e.body.zipcode},(function(t,n){var o=n[0].latitude,a=n[0].longitude;new K({farmer:e.body.farmer,farmName:e.body.farmName,address:e.body.address,city:e.body.city,zipcode:e.body.zipcode,state:e.body.state,imageUrl:e.body.imageUrl,farmerType:e.body.farmerType,location:{type:"Point",coordinates:[o,a]}}).save().then((function(e){r.json(e)})).catch((function(e){r.json(e)}))}))})),W.post("/addFarmProfile",(function(e,r){new C({farmer:e.body.farmer,farm:e.body.farm,displayName:e.body.displayName,description:e.body.description,imageUrl:e.body.imageUrl}).save().then((function(e){r.json(e)})).catch((function(e){return r.json(e)}))})),W.get("/farms",(function(e,r){var t={farms:[]};K.find({},(function(e,n){n.forEach((function(e){t.farms.push(e)})),r.json(t)}))})),W.post("/farmProfile",(function(e,r){var t=e.body.farm._id;console.log(t),C.findOne({farm:t},(function(e,t){r.json(t)})).catch((function(e){return r.json(e)}))})),W.post("/addProduce",(function(e,r){new R({farm:e.body.farm,title:e.body.title,description:e.body.description,price:e.body.price,sku:e.body.sku}).save().then((function(e){r.json(e)})).catch((function(e){return r.json(e)}))})),W.post("/editProduct",(function(e,r){var t=e.body.product_id;R.findOneAndUpdate({_id:t},{$set:{farm:e.body.farm,title:e.body.title,description:e.body.description,price:e.body.price,sku:e.body.sku}},{new:!0},(function(e,t){e&&r.json(e),r.json("Product Updated Succesfully: "+JSON.stringify(t))}))})),W.post("/deleteProduct",(function(e,r){var t=e.body.productId;R.findByIdAndDelete(t,(function(e){e&&r.json(e),r.json({message:"Successfully deleted item: "+t})}))}));var H=t(17),X=t(1).userAuthKey,$=t(1).appAuthKey,ee=t(1).appId;i.a.connect(j.mongoURI,{useNewUrlParser:!0,autoIndex:!1,useUnifiedTopology:!0}).then((function(){return console.log("MongoDB Successfully Connected")})).catch((function(e){return console.log(e)}));var re=o()();re.use(o.a.static("./dist/")),re.use(u()()),t(20),re.use(H.initialize()),re.use(p()());new c.a.Client({userAuthKey:X,app:{appAuthKey:$,appId:ee}});re.use("/api/users",Y),re.use("/api/app",V),re.use("/api/farm",W),re.all("*",(function(e,r){r.sendFile("/index.html",{root:"./dist/"})}));var te=process.env.PORT||8080;re.listen(te,(function(){console.log("***Server running on Port:".concat(te,"***"))}))}]);